<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net10.0-windows10.0.26100.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <RemoveWindowsFrameworkReferences>false</RemoveWindowsFrameworkReferences>
    <CsWinRTGenerateInteropAssembly>true</CsWinRTGenerateInteropAssembly>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\WinRT.Runtime2\WinRT.Runtime2.csproj" />

    <CsWinRTGeneratorAdditionalArgument Include="--some-arg true"/>
  </ItemGroup>

  <PropertyGroup>
    <CsWinRTTasksDirectory>$(MSBuildThisFileDirectory)..\..\WinRT.Interop.Tasks\bin\Debug\net472\</CsWinRTTasksDirectory>
    <CsWinRTToolsDirectory>$(MSBuildThisFileDirectory)..\..\WinRT.Interop.Generator\bin\Debug\net10.0\</CsWinRTToolsDirectory>
  </PropertyGroup>

  <!-- Properties to control importing the 'cswinrtgen' task -->
  <PropertyGroup>
    <CsWinRTTasksAssemblyDirectory Condition="'$(CsWinRTTasksAssemblyDirectory)' == ''">$(CsWinRTTasksDirectory)</CsWinRTTasksAssemblyDirectory>
    <CsWinRTTasksAssemblyName>WinRT.Interop.Tasks.dll</CsWinRTTasksAssemblyName>
    <CsWinRTTasksAssemblyNamespace>WindowsRuntime.Interop.Tasks</CsWinRTTasksAssemblyNamespace>
    <CsWinRTTasksAssemblyPath>$([System.IO.Path]::Combine('$(CsWinRTTasksAssemblyDirectory)', '$(CsWinRTTasksAssemblyName)'))</CsWinRTTasksAssemblyPath>
  </PropertyGroup>
    
  <!-- Load the 'cswinrtgen' task -->
  <UsingTask AssemblyFile="$(CsWinRTTasksAssemblyPath)" TaskName="CsWinRTGenerator" />

  <!-- 'cswinrtgen' task -->
  <Target
    Name="InvokeCsWinRTGenerator"
    DependsOnTargets="CoreCompile;$(GetTargetPathDependsOn);$(GetTargetPathWithTargetPlatformMonikerDependsOn)"
    BeforeTargets="GetTargetPath;GetTargetPathWithTargetPlatformMoniker;GenerateBuildDependencyFile;GeneratePublishDependencyFile"
    Condition="'$(CsWinRTGenerateInteropAssembly)' == 'true'">
    
    <!-- Default property values for 'cswinrtgen' -->
    <PropertyGroup>
      <CsWinRTToolsDirectory Condition="'$(CsWinRTToolsDirectory)' == ''"></CsWinRTToolsDirectory>
      <CsWinRTGeneratorValidateWinRTRuntimeAssemblyVersion Condition="'$(ValidateWinRTRuntimeAssemblyVersion)' == ''">true</CsWinRTGeneratorValidateWinRTRuntimeAssemblyVersion>
      <CsWinRTGeneratorMaxDegreesOfParallelism Condition="'$(CsWinRTGeneratorMaxDegreesOfParallelism)' == ''">-1</CsWinRTGeneratorMaxDegreesOfParallelism>
      <CsWinRTGeneratorStandardOutputImportance Condition="'$(CsWinRTGeneratorStandardOutputImportance)' == ''">High</CsWinRTGeneratorStandardOutputImportance>
      <CsWinRTGeneratorStandardErrorImportance Condition="'$(CsWinRTGeneratorStandardErrorImportance)' == ''">High</CsWinRTGeneratorStandardErrorImportance>
      <CsWinRTGeneratorLogStandardErrorAsError Condition="'$(CsWinRTGeneratorLogStandardErrorAsError)' == ''">true</CsWinRTGeneratorLogStandardErrorAsError>
    </PropertyGroup>

    <!-- Invoke 'cswinrtgen' -->
    <CsWinRTGenerator
      ReferenceAssemblyPaths="@(ReferencePath)"
      OutputAssemblyPath="@(IntermediateAssembly)"
      InteropAssemblyDirectory="$(CsWinRTGeneratorInteropAssemblyDirectory)"
      DebugReproDirectory="$(CsWinRTGeneratorDebugReproDirectory)"
      CsWinRTToolsDirectory="$(CsWinRTToolsDirectory)"
      UseWindowsUIXamlProjections="$(CsWinRTUseWindowsUIXamlProjections)"
      ValidateWinRTRuntimeAssemblyVersion="$(CsWinRTGeneratorValidateWinRTRuntimeAssemblyVersion)"
      MaxDegreesOfParallelism="$(CsWinRTGeneratorMaxDegreesOfParallelism)"
      AdditionalArguments="@(CsWinRTGeneratorAdditionalArgument)"
      StandardOutputImportance="$(CsWinRTGeneratorStandardOutputImportance)"
      StandardErrorImportance="$(CsWinRTGeneratorStandardErrorImportance)"
      LogStandardErrorAsError="$(CsWinRTGeneratorLogStandardErrorAsError)">
      <Output ItemName="CsWinRTGeneratorInteropAssemblyPath" TaskParameter="InteropAssemblyPath" />
    </CsWinRTGenerator>

    <!-- Set the metadata for the interop .dll item -->
    <ItemGroup>
      <CsWinRTGeneratorInteropAssemblyPath Condition="'%(Filename)%(Extension)' == 'WinRT.Interop.dll'">
        <AssemblyName>WinRT.Interop</AssemblyName>
        <TargetFrameworkIdentifier>.NETCoreApp</TargetFrameworkIdentifier>
        <ReferenceOutputAssembly>true</ReferenceOutputAssembly>
        <IncludeRuntimeDependency>true</IncludeRuntimeDependency>
        <Private>true</Private>
        <MSBuildSourceTargetName>InvokeCsWinRTGenerator</MSBuildSourceTargetName>
        <Platforms>AnyCPU</Platforms>
        <CopyLocal>true</CopyLocal>
      </CsWinRTGeneratorInteropAssemblyPath>
    </ItemGroup>

    <!-- Add the interop .dll to the list of reference paths -->
    <ItemGroup>
      <ReferencePath Include="@(CsWinRTGeneratorInteropAssemblyPath)" />
    </ItemGroup>

    <!-- Append to 'FileWrites' so the interop .dll will be removed on clean -->
    <ItemGroup>
      <FileWrites Include="@(CsWinRTGeneratorInteropAssemblyPath)"/>
    </ItemGroup>
  </Target>
</Project>
